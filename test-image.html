<!DOCTYPE html>
<html lang="en">

<head>
    <title>Создайте видео</title>
    <meta charset="utf-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> -->

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.css"
        integrity="sha512-2eMmukTZtvwlfQoG8ztapwAH5fXaQBzaMqdljLopRSA0i6YKM8kBAOrSSykxu9NN9HrtD45lIqfONLII2AFL/Q=="
        crossorigin="anonymous" />

    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.1.0/croppie.css"
        integrity="sha512-7HaFks3nlpta7iAIyi1HSpdO4MCFOeLcTB9Nyp3XiAaJj4kbdKPvxzyffJ5w/AIiLBlnT8HsydAoxWBubjISPQ=="
        crossorigin="anonymous" /> -->
    <!-- <link rel="stylesheet" href="css/croppie.2.6.5.css" /> -->
</head>

<body>
    Hello
    <div id="demo-basic">
    </div>

    <div class="form-group">
        <div class="form-check">
            <input class="form-check-input image-aspect" type="radio" name="imageAspect" id="rbPortraitImage" value="portrait" checked>
            <label class="form-check-label" for="rbPortraitImage">
                Вертикально
            </label>
        </div>
        <div class="form-check behavior-group">
            <input class="form-check-input image-aspect" type="radio" name="imageAspect" id="rbLandscapeImage" value="landscape">
            <label class="form-check-label" for="rbLandscapeImage">
                Горизонтально
            </label>
        </div>
    </div>


    <div>
        <button class="turn-left">Turn left</button>
        <button class="turn-right">Turn right</button>
        <button id="upload-btn">upload</button>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-migrate-3.0.1.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"
        integrity="sha512-Gs+PsXsGkmr+15rqObPJbenQ2wB3qYvTHuJO6YJzPe/dTLvhy0fmae2BcnaozxDo5iaF8emzmCZWbQ1XXiX2Ig=="
        crossorigin="anonymous"></script>

    <script src="js/dm.settings.js"></script>

    <script type="text/javascript">
        $(function () {
            var elem = document.getElementById('demo-basic');
            let croppie = null;

            refreshCroppieImage(elem, 'images/cat.png', this.value);

            $('input[type=radio][name=imageAspect]').change(function () {
                refreshCroppieImage(elem, 'images/cat.png', this.value);
            });

            function refreshCroppieImage(elem, image_url, aspect) {
                if (croppie) {
                    croppie.destroy();
                }

                croppie = createCroppie(elem, aspect);
                croppie.bind({
                    url: image_url
                });

                function createCroppie(elem, ratio) {
                    let viewport = null;
                    let boundary = {
                        width: 200,
                        height: 200
                    };
                    let long_side = 300, short_side = 200
                    let reducCoef = 0.5
                    long_side *= reducCoef
                    short_side *= reducCoef
                    if (ratio == 'landscape') {
                        viewport = {
                            width: long_side,
                            height: short_side
                        }
                    } else {
                        viewport = {
                            width: short_side,
                            height: long_side
                        }
                    }
                    return new Croppie(elem, {
                        viewport: viewport,
                        boundary: boundary,
                        enableOrientation: true
                    });
                }
            }

            //but we don't want blob, need base64, so that API gateway can handle it
            $('#upload-btn').click(function () {
                let resultOpts = { type: 'base64' };

                croppie.result(resultOpts).then(function (imgEncoded) {
                    let data = {
                        'content': imgEncoded
                    }

                    $.ajax({
                        type: 'POST',
                        url: Dm.settings.baseurl + '/images/base64',
                        data: JSON.stringify(data),
                        contentType: 'application/json',
                        success: function (resp) {
                            console.log("image uploaded", resp)
                        },
                        error: function (resp) {
                            console.error("failed to upload", resp)
                        },
                        complete: function () {

                        }
                    });
                });
            })

            $('.turn-left').click(function () {
                croppie.rotate(90)
            })
            $('.turn-right').click(function () {
                croppie.rotate(-90)
            })
        })
    </script>
</body>

</html>